From 627641f227ef9215c2cda148eecba92c4525b3bf Mon Sep 17 00:00:00 2001
From: Ryan Tomayko <rtomayko@gmail.com>
Date: Thu, 9 Jun 2011 19:05:29 -0700
Subject: [PATCH] receive-pack fsck object warnings are non-fatal

Makes git-unpack-objects --strict, and git-index-pack --strict treat
fsck_object() warnings as non-fatal. Currently, warnings cause git-receive-pack
to reject pushes when receive.fsckObjects is set.

All existing warnings come from fsck_tree(). They are:

 - contains full pathnames
 - contains empty pathname
 - contains zero-padded file modes
 - contains bad file modes

fsck.c defines a default fsck_error_function() callback that's called by the
individual fsck_XXX functions to report errors and warnings. It always returns
1 regardless of severity. The default callback is actually only used from
git-unpack-objects and git-index-pack to implement the --strict checks. The
git-fsck builtin defines its own error callback and returns 0 for warnings.
This change modifies the default callback to use the same behavior as the
git-fsck command.
---
 fsck.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/fsck.c b/fsck.c
index 60bd4bb..97502ce 100644
--- a/fsck.c
+++ b/fsck.c
@@ -357,5 +357,6 @@ int fsck_error_function(struct object *obj, int type, const char *fmt, ...)
 
 	error("%s", sb.buf);
 	strbuf_release(&sb);
-	return 1;
+
+	return (type == FSCK_WARN) ? 0 : 1;
 }
-- 
1.7.5.4

