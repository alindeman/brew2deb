From b00c855c378f0c594a37e563e5c1e3a1ce41b8bb Mon Sep 17 00:00:00 2001
From: Ryan Tomayko <rtomayko@gmail.com>
Date: Sat, 25 Jun 2011 03:02:31 -0700
Subject: [PATCH 1/2] naive hiderefs support for refs/pull/* hierarchy

Don't list refs under the refs/pull/* hierarchy so that
git push --mirror won't try to delete them.

These refs are created on the server when a pull request is created
or modified. A pre-receive hook is configured to reject pushes that
attempt to modify them. People maintain non-github hosted canonical
repos and use git push --mirror to sync with repos on github. The
push --mirror command attempts to delete the refs under refs/pull/*
(the canonical repo does not include them), causing the push to be
rejected.

Omitting these refs from the initial ref advertisement sent back
from receive-pack results in push --mirror not trying to delete
them.
---
 builtin/receive-pack.c |    3 +++
 1 file changed, 3 insertions(+)

diff --git a/builtin/receive-pack.c b/builtin/receive-pack.c
index 0afb8b2..df41925 100644
--- a/builtin/receive-pack.c
+++ b/builtin/receive-pack.c
@@ -118,6 +118,9 @@ static int receive_pack_config(const char *var, const char *value, void *cb)
 
 static void show_ref(const char *path, const unsigned char *sha1)
 {
+	if (strncmp(path, "refs/pull/", strlen("refs/pull/")) == 0)
+		return 0;
+
 	if (sent_capabilities)
 		packet_write(1, "%s %s\n", sha1_to_hex(sha1), path);
 	else
-- 
1.7.9.6.6.g6b3b56


From a616b3931659f63c706f600f19b30524fac75dca Mon Sep 17 00:00:00 2001
From: Ryan Tomayko <rtomayko@gmail.com>
Date: Sat, 25 Jun 2011 03:20:58 -0700
Subject: [PATCH 2/2] receive.hiderefs config option - takes single prefix

Makes the hidden ref hierarchy path configurable. This is limited to
a single ref prefix. It should probably be broadened to allow a list
of ref prefixes or glob patterns.
---
 builtin/receive-pack.c |    8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/builtin/receive-pack.c b/builtin/receive-pack.c
index df41925..b22670c 100644
--- a/builtin/receive-pack.c
+++ b/builtin/receive-pack.c
@@ -39,6 +39,7 @@ static int auto_update_server_info;
 static int auto_gc = 1;
 static const char *head_name;
 static void *head_name_to_free;
+static const char *hide_refs;
 static int sent_capabilities;
 
 static enum deny_action parse_deny_action(const char *var, const char *value)
@@ -113,12 +114,17 @@ static int receive_pack_config(const char *var, const char *value, void *cb)
 		return 0;
 	}
 
+	if (strcmp(var, "receive.hiderefs") == 0) {
+		git_config_string(&hide_refs, var, value);
+		return 0;
+	}
+
 	return git_default_config(var, value, cb);
 }
 
 static void show_ref(const char *path, const unsigned char *sha1)
 {
-	if (strncmp(path, "refs/pull/", strlen("refs/pull/")) == 0)
+	if (hide_refs && strncmp(path, hide_refs, strlen(hide_refs)) == 0)
 		return 0;
 
 	if (sent_capabilities)
-- 
1.7.9.6.6.g6b3b56

